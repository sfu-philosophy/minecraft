# minecraft
[![Deploy](https://github.com/sfu-philosophy/minecraft/actions/workflows/deploy.yaml/badge.svg?branch=deploy&event=push)](https://github.com/sfu-philosophy/minecraft/actions/workflows/deploy.yaml)

Configuration and documentation for the SFU Philosophy Minecraft server.


## How does this work?
Borrowing from my experiences of Kubernetes, I'm using [Helm](https://helm.sh/) to generate plugin configuration files from templates.

Servers are configured using the Helm charts (templates) inside the [charts](./charts) directory.


### Rendering
Running `make render` or using [helmaroc](./helmaroc.py) will render the charts and save Bukkit plugin configuration under the `deploy` directory.

If a `.secrets` file exists, it will be used to provide secure secrets (like database passwords) to templates. Note that some templates may not be able to render properly unless run through the CI due to this.

### Deployments
Deploying is done through GitHub Actions.

By pushing to the `deploy` branch, the CI will render all the server templates and upload them to the appropriate servers over FTP.


## Architecture

The server is a pretty basic BungeeCord setup, using Waterfall for the proxy and Paper for the server instances.



---

## Helmaroc
Helmaroc (named after the bird for TLoZ:WW) is a tool that utilizes Helm 3 to generate Minecraft configuration files from templates. This idea was borrowed from the Kubernetes ecosystem.

If a `[chart].yml` file exists under `configs/servers/[server]`, Helmaroc will render the corresponding chart under `charts/[chart]`. The chart values will be loaded from `[chart].yml`.

### Multiple-Values Support
Using YAML front-matter, multiple values files can be specified:

```yaml
---
~include:
  - /configs/shared/something.yml
---

other: content
```

The above snippet would include the values file `{repo_root}/configs/shared/something.yml`.

Values-file ordering is done as follows:

- `.secrets.yml` (generated by the CI)
- `~include` values files, in order.
- The remaining content in the `[chart].yml` file.

### "Wrapper" Templates

Sometimes you have non-YAML files for configuration. Helm doesn't support this out of the box, but Helmaroc does. By using the `.notyml` file extension instead of the real one, you can tell Helmaroc to extract the file contents as part of its rendering:

```yaml
~rename: something.md
~contents: |-
  ## Hello!
  I am not {{ .Values.name.yaml }}, but I'm still a template!
```

The above snippet would move the `~contents` text into a file called `something.md`.
